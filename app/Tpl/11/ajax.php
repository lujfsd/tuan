<?phpdefine("ROOT_PATH", str_replace("app/Tpl/lashou_best","", str_replace("\\","/", dirname(__FILE__))));require  '../../source/db_init.php';require '../../source/comm_init.php';require '../../source/func/com_func.php';require '../../source/user_init.php';require '../../source/class/Pager.php';date_default_timezone_set('PRC');$act=$_REQUEST['act'];if($_GET['indexType'] || $_GET['indexType'] === '0'){    $indexType=$_GET['indexType'];}else{    if($_COOKIE['indexType']){        $indexType = $_COOKIE['indexType'];    }}$GLOBALS['tpl']->assign('type',$type);if($_GET['sc']){    $sc = $_GET['sc'];}else{    if($_COOKIE['sc']){        $sc = $_COOKIE['sc'];    }}if($sc){    setcookie('sc', $sc);}$page = isset ( $_REQUEST ['p'] ) ? intval ( $_REQUEST ['p'] ) > 0 ? intval ( $_REQUEST ['p'] ) : 1 : 1;$now = a_gmtTime();//取整，要做缓存一分钟$where = " status = 1 ";$where .= " and (type_id = 0 or type_id = 1 or type_id = 3)";$where .= " and score_goods <> 1 ";//0:普通商品;1:积分商品;2:抽奖商品;$where .= " and ((promote_begin_time <= ".$now." and promote_end_time >= ".$now.") or (is_preview =1 and promote_begin_time >= ".$now.")) ";if($_REQUEST['m'] == 'Index' && $_REQUEST['a'] =="index"){        $where .= ' AND no_show_index =0 ';}$childIdsUtil = new ChildIds("group_city");$city_ids = $childIdsUtil->getChildIds(C_CITY_ID);array_push($city_ids,C_CITY_ID);$where.=" and (city_id in (".implode(",",$city_ids).") or all_show = 1)";if($sc =="new")        $orderby = " order by id desc ";elseif ($sc =="hot")        $orderby = " order by buy_count desc ";else        $orderby = " order by sort desc,promote_end_time desc,id desc ";$GLOBALS['tpl']->assign('orderby',$orderby);//开始处理分页$page_size = $page;$page_count = a_fanweC("GOODS_LIST_NUM");$limit = ($page_size-1)*$page_count.",".$page_count;$sql = "SELECT `id`,`name_1`,`sn`,`cate_id`,`city_id`,`suppliers_id`,`score_goods`,`click_count`,`cost_price`,`shop_price`,`market_price`,`promote_price`,`promote_begin_time`,`promote_end_time`,`create_time`,`update_time`,`type_id`,`goods_type`,`stock`,`brief_1`,`brand_id`,`is_best`,".           "`is_hot`,`is_new`,`status`,`sort`,`seokeyword_1`,`seocontent_1`,`goods_desc_1`,`small_img`,`big_img`,`origin_img`,`define_small_img`,`is_define_small_img`,`is_inquiry`,`weight`,`spec_type`,`weight_unit`,`score`,`web_reviews`,`goods_reviews`,`min_user_time`,".           "`special_note`,`max_bought`,`is_group_fail`,`complete_time`,`buy_count`,`group_user`,`user_count`,`earnest_money`,`group_bond_end_time`,`expand1`,`expand2`,`expand3`,`expand4`,`u_name`,`referrals`,`close_referrals`,`goods_short_name`,`fail_buy_count`,`free_delivery_amount`,".           "`allow_combine_delivery`,`allow_sms`, (select count(*) from ".DB_PREFIX."message m where m.rec_module = 'Goods' and m.status = 1 and m.rec_id = a.id) as messageCount FROM ".                DB_PREFIX."goods as a where ".$where.$orderby;if($indexType !='2'){    $sql .=" limit ".$limit;}$goods_list = $GLOBALS['db']->getAll($sql);$sql = "SELECT count(*) FROM ".DB_PREFIX."goods as a where 1 = 1 and ".$where;$total = $GLOBALS['db']->getOne($sql);foreach($goods_list as $k=>$v){        if(a_fanweC("URL_ROUTE")==1)        {                if($v['u_name']!='')                        $goods_list[$k]['url'] = "g-".rawurlencode($v['u_name']).".html";                else                        $goods_list[$k]['url'] = "tg-".$v['id'].".html";										$goods_list[$k]['buy_url']="Cart-index-id-".$v['id'].".html";						        }        else        {                $goods_list[$k]['url'] = 'index.php?m=Goods&a=show&id='.$v['id'];				$goods_list[$k]['buy_url']="index.php?m=Cart&a=index&id=".$v['id'];        }        if(intval($goods_list[$k]['stock']) > 0)        {                $goods_list[$k]['surplusCount'] = intval($goods_list[$k]['stock']) - intval($goods_list[$k]['buy_count']);                if($goods_list[$k]['surplusCount'] <= 0)                        $goods_list[$k]['is_none'] = true;        }        if($goods_list[$k]['complete_time'] > 0)                $goods_list[$k]['complete_time_format'] = a_toDate($v['complete_time'],a_L('XY_TIMES_MOD_2'));        else                $goods_list[$k]['complete_time_format'] = "";        $goods_list[$k]['city'] = $GLOBALS['db']->getRowCached("select name,py from ".DB_PREFIX."group_city where id=".$v['city_id']);        $goods_list[$k]['market_price'] = floatval($v['market_price']);        $goods_list[$k]['shop_price'] = floatval($v['shop_price']);        $goods_list[$k]['earnest_money'] = floatval($v['earnest_money']);        $goods_list[$k]['market_price_format'] = a_formatPrice(floatval($v['market_price']));        $goods_list[$k]['shop_price_format'] = a_formatPrice(floatval($v['shop_price']));        if(floatval($v['market_price'])!=0)        {                $goods_list[$k]['discountfb'] = round(($v['shop_price'] / $v['market_price']) * 10,2);        }        else                $goods_list[$k]['discountfb'] = 0;        $goods_list[$k]['save'] = a_formatPrice($v['market_price']-$v['shop_price']);                if($v['small_img']=='')                        $goods_list[$k]['small_img'] = a_fanweC("NO_PIC");                if($v['big_img']=='')                        $goods_list[$k]['big_img'] = a_fanweC("NO_PIC");                if($v['origin_img']=='')                        $goods_list[$k]['origin_img'] = a_fanweC("NO_PIC");}$page = new Pager ( $total, $page_count); //初始化分页对象if($indexType == '2'){    $p='';}else{    $p = $page->show ();}$page_count = ceil($total/$page_count);$GLOBALS ['tpl']->assign ( 'page_count', $page_count );$GLOBALS ['tpl']->assign ( 'CND_URL', str_replace("app/Tpl/lashou_best","", CND_URL));$GLOBALS ['tpl']->assign ( 'pages', $p );$GLOBALS ['tpl']->assign("goods_list",$goods_list);$GLOBALS ['tpl']->assign('indexType',$indexType);if($act == 'resetIndex'){    if($indexType =='0' || $indexType == '2') //默认模板(网格)    {       setcookie('indexType', $indexType,time()+3600*24);       echo  $tpl->fetch('Inc/goods/goods_list.moban');    }    elseif($indexType =='1')//旧版模板    {        setcookie('indexType', $indexType,time()+3600*24);        $currentCity = $GLOBALS['db']->getRowCached("SELECT id,py,`desc`,tip,name,notice,qq_1,qq_2,qq_3,qq_4,qq_5,qq_6 FROM ".DB_PREFIX."group_city where id = ".C_CITY_ID);        $default_city = $GLOBALS['db']->getRowCached("SELECT id,py,name,notice FROM ".DB_PREFIX."group_city where verify = 1 and is_defalut =1");   	$GLOBALS['tpl']->assign("currentCity",$currentCity);   	$GLOBALS['tpl']->assign("default_city",$default_city);   	//搜索次级城市   	$sub_citys = $GLOBALS['db']->getAllCached("select id,pid,py,name from ".DB_PREFIX."group_city WHERE pid in (select pid from ".DB_PREFIX."group_city where id=".C_CITY_ID." and pid<>0) order by sort asc");   	if(!$sub_citys)   	{   		$sub_citys = $GLOBALS['db']->getAllCached("select id,pid,py,name from ".DB_PREFIX."group_city WHERE pid = ".C_CITY_ID." order by sort asc");   	}   	foreach($sub_citys as $idx => $v)        {                    $sub_citys[$idx]['url'] = a_u("Index/index","cityname-{$v['py']}");        }        $GLOBALS['tpl']->assign("sub_citys",$sub_citys);        require '../../source/insert_comm.php';         echo  $tpl->fetch('Inc/goods/goods_listx.moban');        echo '<div id="sidebar" style="padding-top:30px;">';		define("__ROOT__","./");        $tpl->display('Inc/right.moban');        echo '</div>';    }else{       echo  $tpl->fetch('Inc/goods/goods_list.moban');    }}?>